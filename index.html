<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klang Valley Transit Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --success: #00d9a5;
            --warning: #ffc93c;
            --light: #f8f9fa;
            --gray: #6c757d;
            --card-bg: rgba(255,255,255,0.95);
            
            /* Line Colors */
            --mrt-kajang: #7dba00;
            --mrt-putrajaya: #ffcd00;
            --lrt-ampang: #e0115f;
            --lrt-sri-petaling: #e0115f;
            --lrt-kelana-jaya: #dc241f;
            --monorail: #5cb85c;
            --ktm: #003399;
            --klia-express: #6f2da8;
            --brt: #00bfff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--primary);
            min-height: 100vh;
            color: var(--primary);
        }

        /* Animated Background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            z-index: -1;
        }

        .bg-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 217, 165, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--highlight), #ff6b6b);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 30px rgba(233, 69, 96, 0.4);
        }

        h1 {
            color: white;
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
            font-weight: 400;
        }

        /* Main Card */
        .planner-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 35px;
            box-shadow: 
                0 25px 80px rgba(0,0,0,0.4),
                0 10px 30px rgba(0,0,0,0.2);
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Station Selection */
        .station-selector {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
        }

        @media (max-width: 600px) {
            .station-selector {
                grid-template-columns: 1fr;
            }
            .swap-btn {
                order: -1;
                justify-self: center;
                transform: rotate(90deg);
            }
        }

        .field-group {
            position: relative;
        }

        .field-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .station-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }

        .station-select:hover {
            border-color: var(--highlight);
        }

        .station-select:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.1);
        }

        .swap-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swap-btn:hover {
            background: var(--highlight);
            border-color: var(--highlight);
            color: white;
            transform: rotate(180deg);
        }

        /* Action Buttons */
        .btn-row {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }

        .btn-primary {
            flex: 1;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--highlight), #ff6b6b);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(233, 69, 96, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            padding: 16px 24px;
            background: #f8f9fa;
            color: var(--gray);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .results-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .results-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .journey-summary {
            font-size: 0.9rem;
            color: var(--gray);
        }

        /* Route Card */
        .route-card {
            background: linear-gradient(135deg, #f8f9fa, #fff);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .route-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 500px) {
            .route-overview {
                grid-template-columns: 1fr 1fr;
            }
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Fare Display */
        .fare-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .fare-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .fare-header h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .fare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .fare-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fare-card.cashless {
            background: linear-gradient(135deg, #d4f5e9, #a8edce);
            border: 2px solid var(--success);
        }

        .fare-card.cash {
            background: linear-gradient(135deg, #f5f5f5, #e9ecef);
            border: 2px solid #dee2e6;
        }

        .fare-card.cashless::before {
            content: 'RECOMMENDED';
            position: absolute;
            top: 8px;
            right: -30px;
            background: var(--success);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 3px 35px;
            transform: rotate(45deg);
        }

        .fare-type {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .fare-card.cashless .fare-type {
            color: #0a7c5a;
        }

        .fare-card.cash .fare-type {
            color: var(--gray);
        }

        .fare-amount {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .fare-card.cashless .fare-amount {
            color: #0a7c5a;
        }

        .fare-card.cash .fare-amount {
            color: var(--primary);
        }

        .fare-note {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.8;
        }

        .savings-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 10px;
        }

        /* Route Segments */
        .segments-section {
            margin-top: 25px;
        }

        .segments-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .segment {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px dashed #e9ecef;
        }

        .segment:last-child {
            border-bottom: none;
        }

        .segment-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }

        .line-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid;
            background: white;
        }

        .line-connector {
            flex: 1;
            width: 4px;
            min-height: 40px;
        }

        .segment-info {
            flex: 1;
        }

        .segment-station {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .segment-details {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .line-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            margin-right: 8px;
        }

        /* Transfer Badge */
        .transfer-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--warning);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 10px 0;
        }

        /* Disclaimer */
        .disclaimer {
            background: linear-gradient(135deg, #fff9e6, #fff3cd);
            border: 1px solid #ffeeba;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .disclaimer-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .disclaimer-text {
            font-size: 0.8rem;
            color: #856404;
            line-height: 1.5;
        }

        .disclaimer-text strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Tips Box */
        .tips-box {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            border: 1px solid #bee5eb;
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 15px;
        }

        .tips-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #0c5460;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-list {
            list-style: none;
            font-size: 0.8rem;
            color: #0c5460;
        }

        .tips-list li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .tips-list li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        /* Quick Routes */
        .quick-routes {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
        }

        .quick-routes-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--gray);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-route-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-chip {
            padding: 10px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-chip:hover {
            border-color: var(--highlight);
            background: rgba(233, 69, 96, 0.05);
        }

        .quick-chip span {
            opacity: 0.5;
            margin: 0 6px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px 20px;
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
        }

        footer a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
        }

        footer a:hover {
            color: var(--highlight);
        }

        /* Line Colors */
        .line-mrt-kajang { background-color: var(--mrt-kajang); }
        .line-mrt-putrajaya { background-color: var(--mrt-putrajaya); color: #333; }
        .line-lrt-ampang { background-color: var(--lrt-ampang); }
        .line-lrt-sri-petaling { background-color: var(--lrt-sri-petaling); }
        .line-lrt-kelana-jaya { background-color: var(--lrt-kelana-jaya); }
        .line-monorail { background-color: var(--monorail); }
        .line-ktm { background-color: var(--ktm); }
        .line-klia-express { background-color: var(--klia-express); }
        .line-brt { background-color: var(--brt); }

        .dot-mrt-kajang { border-color: var(--mrt-kajang); }
        .dot-mrt-putrajaya { border-color: var(--mrt-putrajaya); }
        .dot-lrt-ampang { border-color: var(--lrt-ampang); }
        .dot-lrt-sri-petaling { border-color: var(--lrt-sri-petaling); }
        .dot-lrt-kelana-jaya { border-color: var(--lrt-kelana-jaya); }
        .dot-monorail { border-color: var(--monorail); }
        .dot-ktm { border-color: var(--ktm); }
        .dot-klia-express { border-color: var(--klia-express); }
        .dot-brt { border-color: var(--brt); }

        .connector-mrt-kajang { background-color: var(--mrt-kajang); }
        .connector-mrt-putrajaya { background-color: var(--mrt-putrajaya); }
        .connector-lrt-ampang { background-color: var(--lrt-ampang); }
        .connector-lrt-sri-petaling { background-color: var(--lrt-sri-petaling); }
        .connector-lrt-kelana-jaya { background-color: var(--lrt-kelana-jaya); }
        .connector-monorail { background-color: var(--monorail); }
        .connector-ktm { background-color: var(--ktm); }
        .connector-klia-express { background-color: var(--klia-express); }
        .connector-brt { background-color: var(--brt); }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">ğŸš‡</div>
                <h1>KL Transit Planner</h1>
            </div>
            <p class="subtitle">Plan your journey across Klang Valley's rail network</p>
        </header>

        <div class="planner-card">
            <!-- Station Selection -->
            <div class="station-selector">
                <div class="field-group">
                    <label>From Station</label>
                    <select id="fromStation" class="station-select">
                        <option value="">Select departure station</option>
                    </select>
                </div>

                <button class="swap-btn" onclick="swapStations()" title="Swap stations">â‡„</button>

                <div class="field-group">
                    <label>To Station</label>
                    <select id="toStation" class="station-select">
                        <option value="">Select arrival station</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-row">
                <button class="btn-primary" onclick="planJourney()">
                    ğŸ” Plan Journey
                </button>
                <button class="btn-secondary" onclick="resetForm()">
                    Reset
                </button>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section">
                <div class="results-header">
                    <span class="results-title">ğŸ¯ Journey Details</span>
                    <span class="journey-summary" id="journeySummary"></span>
                </div>

                <div class="route-card">
                    <!-- Overview Stats -->
                    <div class="route-overview">
                        <div class="stat-box">
                            <div class="stat-icon">â±ï¸</div>
                            <div class="stat-value" id="totalTime">--</div>
                            <div class="stat-label">Duration</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">ğŸš</div>
                            <div class="stat-value" id="totalStops">--</div>
                            <div class="stat-label">Stops</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-icon">ğŸ”„</div>
                            <div class="stat-value" id="totalTransfers">--</div>
                            <div class="stat-label">Transfers</div>
                        </div>
                    </div>

                    <!-- Fare Display -->
                    <div class="fare-section">
                        <div class="fare-header">
                            <span>ğŸ’°</span>
                            <h3>Fare Estimate</h3>
                        </div>
                        <div class="fare-grid">
                            <div class="fare-card cashless">
                                <div class="fare-type">Cashless Fare</div>
                                <div class="fare-amount" id="cashlessFare">RM --</div>
                                <div class="fare-note">Touch 'n Go / MyRapid Card</div>
                                <div class="savings-badge" id="savingsBadge">Save RM --</div>
                            </div>
                            <div class="fare-card cash">
                                <div class="fare-type">Cash Fare</div>
                                <div class="fare-amount" id="cashFare">RM --</div>
                                <div class="fare-note">Token / Ticket</div>
                            </div>
                        </div>
                    </div>

                    <!-- Route Segments -->
                    <div class="segments-section">
                        <div class="segments-title">
                            <span>ğŸ“</span> Route Breakdown
                        </div>
                        <div id="routeSegments"></div>
                    </div>
                </div>

                <!-- Disclaimer -->
                <div class="disclaimer">
                    <div class="disclaimer-icon">âš ï¸</div>
                    <div class="disclaimer-text">
                        <strong>Fare Disclaimer</strong>
                        Fares shown are estimates based on standard pricing and may vary slightly. 
                        Actual fares are determined by the rail operator (Prasarana/KTMB) and are subject to change. 
                        Please verify at the station or via the official MyRapid app for the most accurate pricing.
                    </div>
                </div>

                <!-- Tips -->
                <div class="tips-box">
                    <div class="tips-title">ğŸ’¡ Travel Tips</div>
                    <ul class="tips-list">
                        <li>Cashless fares (Touch 'n Go/MyRapid) are 10-20% cheaper than cash tokens</li>
                        <li>Peak hours: Mon-Fri 7-9 AM & 5-7 PM â€” expect higher crowds</li>
                        <li>First train: ~6:00 AM | Last train: ~11:30 PM (varies by line)</li>
                        <li>Download MyRapid PULSE app for real-time train arrivals</li>
                    </ul>
                </div>
            </div>

            <!-- Quick Routes -->
            <div class="quick-routes">
                <div class="quick-routes-title">âš¡ Popular Routes</div>
                <div class="quick-route-chips">
                    <button class="quick-chip" onclick="quickRoute('kl-sentral', 'klcc')">
                        KL Sentral <span>â†’</span> KLCC
                    </button>
                    <button class="quick-chip" onclick="quickRoute('kajang', 'semantan')">
                        Kajang <span>â†’</span> Semantan
                    </button>
                    <button class="quick-chip" onclick="quickRoute('subang-jaya', 'kl-sentral')">
                        Subang Jaya <span>â†’</span> KL Sentral
                    </button>
                    <button class="quick-chip" onclick="quickRoute('gombak', 'putra-heights')">
                        Gombak <span>â†’</span> Putra Heights
                    </button>
                    <button class="quick-chip" onclick="quickRoute('kwasa-damansara', 'putrajaya-sentral')">
                        Kwasa D. <span>â†’</span> Putrajaya
                    </button>
                    <button class="quick-chip" onclick="quickRoute('batu-caves', 'kajang')">
                        Batu Caves <span>â†’</span> Kajang
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>Built for Klang Valley commuters â€¢ Data based on RapidKL & KTMB fares</p>
            <p style="margin-top: 8px;">
                <a href="https://www.myrapid.com.my" target="_blank">MyRapid Official</a> â€¢ 
                <a href="https://mrt.com.my" target="_blank">MRT Corp</a>
            </p>
        </footer>
    </div>

    <script>
        // =============================================
        // KLANG VALLEY TRANSIT DATA
        // Based on Official RapidKL Station Lists
        // =============================================
        
        const transitLines = {
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MRT KAJANG LINE (29 stations) - Green Line 9
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'mrt-kajang': {
                name: 'MRT Kajang Line',
                code: 'MRT-KJ',
                color: '#7dba00',
                stations: [
                    'Kwasa Damansara', 'Kwasa Sentral', 'Kota Damansara', 'Surian',
                    'Mutiara Damansara', 'Bandar Utama', 'TTDI', 'Phileo Damansara',
                    'Pusat Bandar Damansara', 'Semantan', 'Muzium Negara', 'Pasar Seni',
                    'Merdeka', 'Bukit Bintang', 'Tun Razak Exchange', 'Cochrane', 'Maluri',
                    'Taman Pertama', 'Taman Midah', 'Taman Mutiara', 'Taman Connaught',
                    'Taman Suntex', 'Sri Raya', 'Bandar Tun Hussein Onn', 'Batu 11 Cheras',
                    'Bukit Dukung', 'Sungai Jernih', 'Stadium Kajang', 'Kajang'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MRT PUTRAJAYA LINE (36 stations) - Yellow Line 12
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'mrt-putrajaya': {
                name: 'MRT Putrajaya Line',
                code: 'MRT-PY',
                color: '#ffcd00',
                stations: [
                    'Kwasa Damansara', 'Kampung Selamat', 'Sungai Buloh', 'Damansara Damai',
                    'Sri Damansara Barat', 'Sri Damansara Sentral', 'Sri Damansara Timur',
                    'Metro Prima', 'Kepong Baru', 'Jinjang', 'Sri Delima', 'Kampung Batu',
                    'Kentomen', 'Jalan Ipoh', 'Sentul Barat', 'Titiwangsa',
                    'Hospital Kuala Lumpur', 'Raja Uda', 'Ampang Park', 'Persiaran KLCC',
                    'Conlay', 'Tun Razak Exchange', 'Chan Sow Lin', 'Kuchai',
                    'Taman Naga Emas', 'Sungai Besi', 'Serdang Raya Utara',
                    'Serdang Raya Selatan', 'Serdang Jaya', 'UPM', 'Taman Equine',
                    'Putra Permai', '16 Sierra', 'Cyberjaya Utara', 'Cyberjaya City Centre',
                    'Putrajaya Sentral'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LRT KELANA JAYA LINE (37 stations) - Red Line 5
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'lrt-kelana-jaya': {
                name: 'LRT Kelana Jaya Line',
                code: 'LRT-KJ',
                color: '#dc241f',
                stations: [
                    'Gombak', 'Taman Melati', 'Wangsa Maju', 'Sri Rampai', 'Setiawangsa',
                    'Jelatek', 'Dato Keramat', 'Damai', 'Ampang Park', 'KLCC',
                    'Kampung Baru', 'Dang Wangi', 'Masjid Jamek', 'Pasar Seni', 'KL Sentral',
                    'Bangsar', 'Abdullah Hukum', 'Kerinchi', 'Universiti', 'Taman Jaya',
                    'Asia Jaya', 'Taman Paramount', 'Taman Bahagia', 'Kelana Jaya', 'Lembah Subang',
                    'Ara Damansara', 'Glenmarie', 'Subang Jaya', 'SS 15', 'SS 18',
                    'USJ 7', 'Taipan', 'Wawasan', 'USJ 21', 'Alam Megah',
                    'Subang Alam', 'Putra Heights'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LRT SRI PETALING LINE (30 stations) - Pink Line 4
            // Sentul Timur â†’ Putra Heights
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'lrt-sri-petaling': {
                name: 'LRT Sri Petaling Line',
                code: 'LRT-SP',
                color: '#e0115f',
                stations: [
                    'Sentul Timur', 'Sentul', 'Titiwangsa', 'PWTC', 'Sultan Ismail',
                    'Bandaraya', 'Masjid Jamek', 'Plaza Rakyat', 'Hang Tuah', 'Pudu',
                    'Chan Sow Lin', 'Cheras', 'Salak Selatan', 'Bandar Tun Razak',
                    'Bandar Tasik Selatan', 'Sungai Besi', 'Bukit Jalil', 'Sri Petaling',
                    'Awan Besar', 'Muhibbah', 'Alam Sutera', 'Kinrara BK5',
                    'IOI Puchong Jaya', 'Pusat Bandar Puchong', 'Taman Perindustrian Puchong',
                    'Bandar Puteri', 'Puchong Perdana', 'Puchong Prima', 'Putra Heights'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LRT AMPANG LINE (18 stations) - Pink Line 3
            // Sentul Timur â†’ Ampang
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'lrt-ampang': {
                name: 'LRT Ampang Line',
                code: 'LRT-AG',
                color: '#e0115f',
                stations: [
                    'Sentul Timur', 'Sentul', 'Titiwangsa', 'PWTC', 'Sultan Ismail',
                    'Bandaraya', 'Masjid Jamek', 'Plaza Rakyat', 'Hang Tuah', 'Pudu',
                    'Chan Sow Lin', 'Miharja', 'Maluri', 'Pandan Jaya', 'Pandan Indah',
                    'Cempaka', 'Cahaya', 'Ampang'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // KL MONORAIL (12 stations) - Green Line 8
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'monorail': {
                name: 'KL Monorail',
                code: 'MR',
                color: '#5cb85c',
                stations: [
                    'KL Sentral', 'Tun Sambanthan', 'Maharajalela', 'Hang Tuah',
                    'Imbi', 'Bukit Bintang', 'Raja Chulan', 'Bukit Nanas',
                    'Dang Wangi', 'Medan Tuanku', 'Chow Kit', 'Titiwangsa'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // KTM BATU CAVES â€“ PULAU SEBANG LINE (24 stations) - Blue Line 1
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'ktm-batu-caves': {
                name: 'KTM Batu Caves - Pulau Sebang Line',
                code: 'KTM-BC',
                color: '#003399',
                stations: [
                    'Batu Caves', 'Taman Wahyu', 'Kampung Batu', 'Kentonmen', 'Sentul',
                    'Bank Negara', 'Kuala Lumpur', 'Mid Valley', 'Seputeh', 'Salak Selatan',
                    'Bandar Tasik Selatan', 'Serdang', 'Kajang', 'UKM', 'Bangi',
                    'Batang Benar', 'Nilai', 'Labu', 'Tiroi', 'Seremban',
                    'Senawang', 'Sungai Gadut', 'Rembau', 'Pulau Sebang'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // KTM TANJUNG MALIM â€“ PORT KLANG LINE (33 stations) - Blue Line 2
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'ktm-port-klang': {
                name: 'KTM Tanjung Malim - Port Klang Line',
                code: 'KTM-PK',
                color: '#003399',
                stations: [
                    'Tanjung Malim', 'Kuala Kubu Bharu', 'Rasa', 'Batang Kali', 'Serendah',
                    'Rawang', 'Kuang', 'Sungai Buloh', 'Kepong Sentral', 'Kepong',
                    'Segambut', 'Bank Negara', 'Kuala Lumpur', 'Mid Valley', 'Seputeh',
                    'Pantai Dalam', 'Angkasapuri', 'Abdullah Hukum', 'Petaling',
                    'Kampung Dato Harun', 'Seri Setia', 'Setia Jaya', 'Subang Jaya',
                    'Batu Tiga', 'Shah Alam', 'Padang Jawa', 'Bukit Badak', 'Klang',
                    'Teluk Pulai', 'Teluk Gadong', 'Jalan Kastam', 'Putra', 'Port Klang'
                ]
            },
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // KLIA EXPRESS/TRANSIT (5 stations) - Purple Line 6/7
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            'klia-express': {
                name: 'KLIA Express/Transit',
                code: 'ERL',
                color: '#6f2da8',
                stations: [
                    'KL Sentral', 'Bandar Tasik Selatan', 'Putrajaya & Cyberjaya',
                    'KLIA T1', 'KLIA T2'
                ]
            }
        };

        // =============================================
        // FARE CALCULATION MODULE
        // Based on Official RapidKL & KTMB Fare Formulas
        // =============================================

        const fareCalculator = {
            
            /**
             * LRT/MRT Fare Calculation (RapidKL)
             * 
             * Official Formula:
             * Base fare F0 = RM 0.80
             * D = number of stations traveled
             * 
             * Increment I(D):
             * - If D <= 3:      I = 0.40 Ã— D
             * - If 4 <= D <= 8: I = 1.20 + 0.25 Ã— (D - 3)
             * - If D > 8:       I = 2.45 + 0.15 Ã— (D - 8)
             * 
             * Fare = round((F0 + I) to nearest 0.10)
             * Cash = Fare + RM 0.30, rounded to nearest 0.10
             */
            calculateRapidKL: function(stationCount) {
                const F0 = 0.80; // Base fare
                const D = stationCount;
                let I = 0;

                if (D <= 0) {
                    return { cashless: 0.80, cash: 1.10 };
                }

                // Calculate increment based on tier
                if (D <= 3) {
                    I = 0.40 * D;
                } else if (D <= 8) {
                    I = 1.20 + 0.25 * (D - 3);
                } else {
                    I = 2.45 + 0.15 * (D - 8);
                }

                // Calculate and round fare
                let cashlessFare = Math.round((F0 + I) * 10) / 10;
                
                // Apply cap
                cashlessFare = Math.min(cashlessFare, 6.40);
                
                // Cash fare = Cashless + RM 0.30, rounded
                let cashFare = Math.round((cashlessFare + 0.30) * 10) / 10;
                cashFare = Math.min(cashFare, 7.70);

                return { cashless: cashlessFare, cash: cashFare };
            },

            /**
             * KTM Komuter Fare Calculation
             * 
             * Official Formula:
             * Base fare F0 = RM 1.30
             * D = number of stations traveled
             * 
             * Increment I(D):
             * - If D <= 5:       I = 0.45 Ã— D
             * - If 6 <= D <= 15: I = 2.25 + 0.30 Ã— (D - 5)
             * - If D > 15:       I = 5.25 + 0.15 Ã— (D - 15)
             * 
             * Fare = round((F0 + I) to nearest 0.10)
             * Cash = Fare + RM 0.30, rounded to nearest 0.10
             */
            calculateKTM: function(stationCount) {
                const F0 = 1.30; // Base fare
                const D = stationCount;
                let I = 0;

                if (D <= 0) {
                    return { cashless: 1.30, cash: 1.60 };
                }

                // Calculate increment based on tier
                if (D <= 5) {
                    I = 0.45 * D;
                } else if (D <= 15) {
                    I = 2.25 + 0.30 * (D - 5);
                } else {
                    I = 5.25 + 0.15 * (D - 15);
                }

                // Calculate and round fare
                let cashlessFare = Math.round((F0 + I) * 10) / 10;
                
                // Apply cap
                cashlessFare = Math.min(cashlessFare, 12.80);
                
                // Cash fare = Cashless + RM 0.30, rounded
                let cashFare = Math.round((cashlessFare + 0.30) * 10) / 10;
                cashFare = Math.min(cashFare, 16.00);

                return { cashless: cashlessFare, cash: cashFare };
            },

            // KLIA Express/Transit fixed fares
            kliaExpress: {
                'KL Sentral-KLIA T1': { cashless: 55.00, cash: 55.00 },
                'KL Sentral-KLIA T2': { cashless: 55.00, cash: 55.00 },
                'KL Sentral-Putrajaya & Cyberjaya': { cashless: 14.00, cash: 14.00 },
                'Bandar Tasik Selatan-KLIA T1': { cashless: 49.50, cash: 49.50 },
                'Bandar Tasik Selatan-KLIA T2': { cashless: 49.50, cash: 49.50 },
                'Bandar Tasik Selatan-Putrajaya & Cyberjaya': { cashless: 9.40, cash: 9.40 },
                'Putrajaya & Cyberjaya-KLIA T1': { cashless: 42.70, cash: 42.70 },
                'Putrajaya & Cyberjaya-KLIA T2': { cashless: 42.70, cash: 42.70 },
                'KLIA T1-KLIA T2': { cashless: 2.00, cash: 2.00 }
            },

            // Main calculation function
            calculate: function(fromStation, toStation, line, stationCount) {
                // KLIA Express: fixed fares
                if (line === 'klia-express') {
                    const key = `${fromStation}-${toStation}`;
                    const reverseKey = `${toStation}-${fromStation}`;
                    return this.kliaExpress[key] || this.kliaExpress[reverseKey] || { cashless: 55.00, cash: 55.00 };
                }

                // KTM lines
                if (line.startsWith('ktm')) {
                    return this.calculateKTM(stationCount);
                }

                // RapidKL (LRT, MRT, Monorail, BRT)
                return this.calculateRapidKL(stationCount);
            }
        };

        // =============================================
        // JOURNEY TIME CALCULATION
        // Time = (Stations Ã— Avg Time) + (Transfers Ã— 5 min)
        // =============================================

        const timeCalculator = {
            // Average minutes per station by line type
            avgTimePerStation: {
                'mrt-kajang': 2.5,       // Urban MRT
                'mrt-putrajaya': 2.5,    // Urban MRT
                'lrt-kelana-jaya': 2.5,  // Urban LRT
                'lrt-ampang': 2.5,       // Urban LRT
                'lrt-sri-petaling': 2.5, // Urban LRT
                'monorail': 2,           // City center, short stops
                'ktm-batu-caves': 4,     // Suburban KTM
                'ktm-port-klang': 4,     // Suburban KTM
                'klia-express': 15       // Express service
            },

            transferTime: 5, // Minutes per interchange

            // Calculate time for single line journey
            calculate: function(line, stationCount, transfers = 0) {
                const avgTime = this.avgTimePerStation[line] || 3;
                const travelTime = stationCount * avgTime;
                const totalTime = travelTime + (transfers * this.transferTime);
                return Math.round(totalTime);
            },

            // Calculate time for multi-segment journey
            calculateMultiSegment: function(segments) {
                let total = 0;
                segments.forEach((seg, i) => {
                    const avgTime = this.avgTimePerStation[seg.line.lineId] || 3;
                    total += seg.stations * avgTime;
                    // Add transfer time between segments
                    if (i < segments.length - 1) {
                        total += this.transferTime;
                    }
                });
                return Math.round(total);
            }
        };

        // =============================================
        // ROUTING ENGINE
        // =============================================

        // Interchange stations (based on official RapidKL map)
        const interchanges = {
            // MRT Kajang interchanges
            'Kwasa Damansara': ['mrt-kajang', 'mrt-putrajaya'],
            'Tun Razak Exchange': ['mrt-kajang', 'mrt-putrajaya'],
            'Pasar Seni': ['lrt-kelana-jaya', 'mrt-kajang'],
            'Bukit Bintang': ['mrt-kajang', 'monorail'],
            'Maluri': ['lrt-ampang', 'mrt-kajang'],
            'Muzium Negara': ['mrt-kajang'],
            'Semantan': ['mrt-kajang'],
            
            // MRT Putrajaya interchanges
            'Sungai Buloh': ['mrt-putrajaya', 'ktm-port-klang'],
            'Kampung Batu': ['mrt-putrajaya', 'ktm-batu-caves'],
            'Kentonmen': ['mrt-putrajaya', 'ktm-batu-caves'],
            'Titiwangsa': ['lrt-ampang', 'lrt-sri-petaling', 'mrt-putrajaya', 'monorail'],
            'Ampang Park': ['lrt-kelana-jaya', 'mrt-putrajaya'],
            'Chan Sow Lin': ['lrt-ampang', 'lrt-sri-petaling', 'mrt-putrajaya'],
            'Sungai Besi': ['lrt-sri-petaling', 'mrt-putrajaya'],
            
            // LRT Kelana Jaya interchanges
            'Masjid Jamek': ['lrt-kelana-jaya', 'lrt-ampang', 'lrt-sri-petaling'],
            'KL Sentral': ['lrt-kelana-jaya', 'monorail', 'klia-express'],
            'Dang Wangi': ['lrt-kelana-jaya', 'monorail'],
            'Putra Heights': ['lrt-kelana-jaya', 'lrt-sri-petaling'],
            'Abdullah Hukum': ['lrt-kelana-jaya', 'ktm-port-klang'],
            'Subang Jaya': ['lrt-kelana-jaya', 'ktm-port-klang'],
            
            // LRT Ampang/Sri Petaling shared
            'Sentul Timur': ['lrt-ampang', 'lrt-sri-petaling'],
            'Sentul': ['lrt-ampang', 'lrt-sri-petaling', 'ktm-batu-caves'],
            'PWTC': ['lrt-ampang', 'lrt-sri-petaling'],
            'Sultan Ismail': ['lrt-ampang', 'lrt-sri-petaling'],
            'Bandaraya': ['lrt-ampang', 'lrt-sri-petaling'],
            'Plaza Rakyat': ['lrt-ampang', 'lrt-sri-petaling'],
            'Hang Tuah': ['lrt-ampang', 'lrt-sri-petaling', 'monorail'],
            'Pudu': ['lrt-ampang', 'lrt-sri-petaling'],
            
            // LRT Sri Petaling specific
            'Bandar Tasik Selatan': ['lrt-sri-petaling', 'ktm-batu-caves', 'klia-express'],
            'Salak Selatan': ['lrt-sri-petaling', 'ktm-batu-caves'],
            
            // KTM shared stations (both lines)
            'Bank Negara': ['ktm-batu-caves', 'ktm-port-klang'],
            'Kuala Lumpur': ['ktm-batu-caves', 'ktm-port-klang'],
            'Mid Valley': ['ktm-batu-caves', 'ktm-port-klang'],
            'Seputeh': ['ktm-batu-caves', 'ktm-port-klang'],
            
            // KTM Batu Caves specific
            'Serdang': ['ktm-batu-caves'],
            'Kajang': ['mrt-kajang', 'ktm-batu-caves'],
            
            // KTM Port Klang specific
            'Rawang': ['ktm-port-klang'],
            'Kepong Sentral': ['ktm-port-klang'],
            'Klang': ['ktm-port-klang'],
            'Setia Jaya': ['ktm-port-klang']
        };

        // Build station database with line info
        let stationDatabase = {};
        
        function initializeStations() {
            stationDatabase = {};
            
            for (const [lineId, lineData] of Object.entries(transitLines)) {
                lineData.stations.forEach((station, index) => {
                    const stationKey = station.toLowerCase().replace(/\s+/g, '-');
                    
                    if (!stationDatabase[stationKey]) {
                        stationDatabase[stationKey] = {
                            name: station,
                            lines: []
                        };
                    }
                    
                    stationDatabase[stationKey].lines.push({
                        lineId: lineId,
                        lineName: lineData.name,
                        lineCode: lineData.code,
                        lineColor: lineData.color,
                        index: index
                    });
                });
            }
            
            // Populate dropdowns
            populateStationDropdowns();
        }

        function populateStationDropdowns() {
            const fromSelect = document.getElementById('fromStation');
            const toSelect = document.getElementById('toStation');
            
            // Get unique stations sorted alphabetically
            const sortedStations = Object.entries(stationDatabase)
                .sort((a, b) => a[1].name.localeCompare(b[1].name));
            
            // Create optgroups by first letter
            let currentLetter = '';
            let optgroup = null;
            
            sortedStations.forEach(([key, data]) => {
                const firstLetter = data.name[0].toUpperCase();
                
                const option1 = document.createElement('option');
                option1.value = key;
                option1.textContent = data.name;
                option1.dataset.lines = data.lines.map(l => l.lineCode).join(', ');
                
                const option2 = option1.cloneNode(true);
                
                fromSelect.appendChild(option1);
                toSelect.appendChild(option2);
            });
        }

        // Find route between two stations
        function findRoute(fromKey, toKey) {
            const fromStation = stationDatabase[fromKey];
            const toStation = stationDatabase[toKey];
            
            if (!fromStation || !toStation) {
                return null;
            }

            // Check if stations share a line (direct route)
            for (const fromLine of fromStation.lines) {
                for (const toLine of toStation.lines) {
                    if (fromLine.lineId === toLine.lineId) {
                        const stationCount = Math.abs(toLine.index - fromLine.index);
                        const duration = timeCalculator.calculate(fromLine.lineId, stationCount, 0);
                        
                        return {
                            direct: true,
                            segments: [{
                                from: fromStation.name,
                                to: toStation.name,
                                line: fromLine,
                                stations: stationCount,
                                duration: duration
                            }],
                            totalStations: stationCount,
                            totalDuration: duration,
                            transfers: 0,
                            fare: fareCalculator.calculate(
                                fromStation.name, 
                                toStation.name, 
                                fromLine.lineId, 
                                stationCount
                            )
                        };
                    }
                }
            }

            // Need to find transfer route
            // Simple implementation: find common interchange
            let bestRoute = null;
            let shortestDuration = Infinity;

            for (const [interchangeName, interchangeLines] of Object.entries(interchanges)) {
                const interchangeKey = interchangeName.toLowerCase().replace(/\s+/g, '-');
                const interchangeStation = stationDatabase[interchangeKey];
                
                if (!interchangeStation) continue;

                // Check if we can get from origin to interchange
                for (const fromLine of fromStation.lines) {
                    const interchangeOnFromLine = interchangeStation.lines.find(l => l.lineId === fromLine.lineId);
                    
                    if (interchangeOnFromLine) {
                        // Check if we can get from interchange to destination
                        for (const toLine of toStation.lines) {
                            const interchangeOnToLine = interchangeStation.lines.find(l => l.lineId === toLine.lineId);
                            
                            if (interchangeOnToLine && fromLine.lineId !== toLine.lineId) {
                                const leg1Stations = Math.abs(interchangeOnFromLine.index - fromLine.index);
                                const leg2Stations = Math.abs(toLine.index - interchangeOnToLine.index);
                                const totalStations = leg1Stations + leg2Stations;
                                
                                // Calculate time using timeCalculator
                                const leg1Time = timeCalculator.calculate(fromLine.lineId, leg1Stations, 0);
                                const leg2Time = timeCalculator.calculate(toLine.lineId, leg2Stations, 0);
                                const totalDuration = leg1Time + leg2Time + timeCalculator.transferTime;
                                
                                if (totalDuration < shortestDuration) {
                                    shortestDuration = totalDuration;
                                    
                                    // Calculate combined fare
                                    const fare1 = fareCalculator.calculate(
                                        fromStation.name, interchangeName, fromLine.lineId, leg1Stations
                                    );
                                    const fare2 = fareCalculator.calculate(
                                        interchangeName, toStation.name, toLine.lineId, leg2Stations
                                    );
                                    
                                    // For integrated network, use the longer journey fare (not sum)
                                    const combinedFare = fareCalculator.calculate(
                                        fromStation.name, toStation.name, fromLine.lineId, totalStations, 1
                                    );

                                    bestRoute = {
                                        direct: false,
                                        segments: [
                                            {
                                                from: fromStation.name,
                                                to: interchangeName,
                                                line: fromLine,
                                                stations: leg1Stations,
                                                duration: leg1Time
                                            },
                                            {
                                                from: interchangeName,
                                                to: toStation.name,
                                                line: toLine,
                                                stations: leg2Stations,
                                                duration: leg2Time
                                            }
                                        ],
                                        interchange: interchangeName,
                                        totalStations: totalStations,
                                        totalDuration: totalDuration,
                                        transfers: 1,
                                        fare: combinedFare
                                    };
                                }
                            }
                        }
                    }
                }
            }

            return bestRoute;
        }

        // =============================================
        // UI FUNCTIONS
        // =============================================

        function swapStations() {
            const fromSelect = document.getElementById('fromStation');
            const toSelect = document.getElementById('toStation');
            
            const temp = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = temp;
        }

        function resetForm() {
            document.getElementById('fromStation').value = '';
            document.getElementById('toStation').value = '';
            document.getElementById('resultsSection').classList.remove('active');
        }

        function quickRoute(from, to) {
            document.getElementById('fromStation').value = from;
            document.getElementById('toStation').value = to;
            planJourney();
        }

        function planJourney() {
            const fromKey = document.getElementById('fromStation').value;
            const toKey = document.getElementById('toStation').value;

            if (!fromKey || !toKey) {
                alert('Please select both departure and arrival stations');
                return;
            }

            if (fromKey === toKey) {
                alert('Please select different stations');
                return;
            }

            const route = findRoute(fromKey, toKey);

            if (!route) {
                alert('Sorry, could not find a route between these stations. They may not be connected yet.');
                return;
            }

            displayResults(route, fromKey, toKey);
        }

        function displayResults(route, fromKey, toKey) {
            const resultsSection = document.getElementById('resultsSection');
            
            // Update summary
            document.getElementById('journeySummary').textContent = 
                `${stationDatabase[fromKey].name} â†’ ${stationDatabase[toKey].name}`;
            
            // Update stats
            document.getElementById('totalTime').textContent = `${route.totalDuration} min`;
            document.getElementById('totalStops').textContent = route.totalStations;
            document.getElementById('totalTransfers').textContent = route.transfers;
            
            // Update fares
            document.getElementById('cashlessFare').textContent = `RM ${route.fare.cashless.toFixed(2)}`;
            document.getElementById('cashFare').textContent = `RM ${route.fare.cash.toFixed(2)}`;
            
            const savings = (route.fare.cash - route.fare.cashless).toFixed(2);
            document.getElementById('savingsBadge').textContent = `Save RM ${savings}`;
            
            // Build route segments
            const segmentsContainer = document.getElementById('routeSegments');
            segmentsContainer.innerHTML = '';
            
            route.segments.forEach((segment, index) => {
                const lineClass = segment.line.lineId.replace(/\s+/g, '-');
                
                // Starting station
                const startHtml = `
                    <div class="segment">
                        <div class="segment-line">
                            <div class="line-dot dot-${lineClass}"></div>
                            <div class="line-connector connector-${lineClass}"></div>
                        </div>
                        <div class="segment-info">
                            <div class="segment-station">${segment.from}</div>
                            <div class="segment-details">
                                <span class="line-badge line-${lineClass}">${segment.line.lineCode}</span>
                                Board ${segment.line.lineName}
                            </div>
                        </div>
                    </div>
                `;
                segmentsContainer.innerHTML += startHtml;
                
                // Transfer indicator (if not last segment)
                if (index < route.segments.length - 1) {
                    const transferHtml = `
                        <div class="segment">
                            <div class="segment-line">
                                <div class="line-dot dot-${lineClass}"></div>
                            </div>
                            <div class="segment-info">
                                <div class="segment-station">${segment.to}</div>
                                <div class="transfer-badge">
                                    ğŸ”„ Transfer to ${route.segments[index + 1].line.lineName}
                                </div>
                                <div class="segment-details">
                                    ${segment.stations} stops â€¢ ${segment.duration} min
                                </div>
                            </div>
                        </div>
                    `;
                    segmentsContainer.innerHTML += transferHtml;
                }
            });
            
            // Final destination
            const lastSegment = route.segments[route.segments.length - 1];
            const lastLineClass = lastSegment.line.lineId.replace(/\s+/g, '-');
            const endHtml = `
                <div class="segment">
                    <div class="segment-line">
                        <div class="line-dot dot-${lastLineClass}" style="background: var(--${lastLineClass.replace('line-', '')}, #333); border-color: var(--${lastLineClass.replace('line-', '')}, #333);"></div>
                    </div>
                    <div class="segment-info">
                        <div class="segment-station">${lastSegment.to}</div>
                        <div class="segment-details">
                            ğŸ¯ Destination â€¢ ${lastSegment.stations} stops â€¢ ${lastSegment.duration} min
                        </div>
                    </div>
                </div>
            `;
            segmentsContainer.innerHTML += endHtml;
            
            // Show results
            resultsSection.classList.add('active');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeStations);
    </script>
</body>
</html>
